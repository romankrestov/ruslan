<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Рассказы по фене — 18+</title>
  <meta name="description" content="Одностраничный сайт для публикации взрослых рассказов. Админ-панель, сменные яркие обложки, символика и локальное хранилище."/>
  <style>
    :root{
      --bg:#0a0a0f;
      --fg:#eef2f7;
      --muted:#b6c2d0;
      --accent:#ff3cac;
      --accent2:#784ba0;
      --accent3:#2b86c5;
      --card:#11131a;
      --card2:#171a22;
      --good:#28c76f;
      --warn:#ff9f43;
      --bad:#ea5455;
      --link:#5cc8ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Верхняя панель */
    header{
      position:sticky; top:0; z-index:1000;
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(10,10,15,.8), rgba(10,10,15,.3));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:14px 18px; display:flex; align-items:center; gap:14px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:12px; text-decoration:none; color:var(--fg)}
    .logo{
      width:40px; height:40px; border-radius:50%;
      background: radial-gradient(120% 120% at 0% 0%, var(--accent) 0%, var(--accent2) 55%, var(--accent3) 100%);
      box-shadow:0 6px 18px rgba(255,60,172,.35), inset 0 0 30px rgba(255,255,255,.08);
      display:grid; place-items:center; overflow:hidden; position:relative;
    }
    .logo svg{width:28px; height:28px; filter:drop-shadow(0 2px 6px rgba(0,0,0,.5))}
    .title{font-weight:700; letter-spacing:.2px}
    .badge18{
      margin-left:6px; padding:2px 8px; border-radius:999px; font-size:.75rem;
      color:#111; background:linear-gradient(90deg, #fbd72b, #f9484a);
      font-weight:700;
    }

    .spacer{flex:1}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    button, .btn{
      appearance:none; border:none; border-radius:12px; padding:10px 14px; cursor:pointer;
      background:linear-gradient(180deg,#222636,#171b27); color:var(--fg);
      box-shadow: var(--shadow), inset 0 0 0 1px rgba(255,255,255,.05);
      transition: transform .05s ease, background .2s ease, box-shadow .2s ease, opacity .2s ease;
    }
    button:hover{background:linear-gradient(180deg,#2a3044,#1b2030)}
    button:active{transform:translateY(1px)}
    .btn-ghost{
      background:transparent; border:1px solid rgba(255,255,255,.15)
    }
    .btn-accent{
      background:linear-gradient(90deg, var(--accent), var(--accent3));
      box-shadow: 0 8px 20px rgba(255,60,172,.3);
    }
    input, textarea, select{
      background:#0f121a; color:var(--fg); border:1px solid rgba(255,255,255,.12);
      border-radius:12px; padding:10px 12px; outline:none; width:100%;
    }
    .search{
      display:flex; align-items:center; gap:8px; padding:8px 10px; background:#0f121a; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      min-width:220px;
    }
    .search input{background:transparent; border:none; padding:6px 4px}

    /* Обложка */
    .cover{
      position:relative; overflow:hidden; border-bottom:1px solid rgba(255,255,255,.06);
    }
    .cover-inner{
      max-width:1100px; margin:0 auto; padding:36px 18px 28px 18px; display:flex; align-items:center; gap:20px; min-height:220px;
    }
    .cover .symbol{
      width:120px; height:120px; border-radius:24px;
      display:grid; place-items:center; background:rgba(0,0,0,.15);
      border:1px solid rgba(255,255,255,.12); backdrop-filter: blur(6px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 20px 40px rgba(0,0,0,.35);
    }
    .cover h1{font-size:1.8rem; margin:0 0 8px}
    .cover p{margin:0; color:var(--muted)}
    .cover-actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}

    /* Градиентные темы обложек */
    .cover-1{ background: radial-gradient(120% 90% at 10% 10%, #ff3cac 0%, #784ba0 45%, #2b86c5 100%)}
    .cover-2{ background: radial-gradient(120% 90% at 90% 10%, #ff9a9e 0%, #fad0c4 50%, #fcb69f 100%)}
    .cover-3{ background: radial-gradient(120% 90% at 10% 90%, #43e97b 0%, #38f9d7 60%, #00c6ff 100%)}
    .cover-4{ background: radial-gradient(120% 90% at 90% 90%, #f6d365 0%, #fda085 50%, #fbc2eb 100%)}
    .cover-5{ background: radial-gradient(120% 90% at 30% 30%, #ff512f 0%, #f09819 50%, #ef629f 100%)}

    /* Контент */
    main{max-width:1100px; margin:0 auto; padding:20px 18px 60px}
    .grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:14px;
    }
    .card{
      background:linear-gradient(180deg, #121522, #0e111a);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius); padding:14px; box-shadow: var(--shadow);
      display:flex; flex-direction:column; gap:10px;
    }
    .card h3{margin:0; font-size:1.05rem}
    .meta{font-size:.85rem; color:var(--muted)}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    .tag{font-size:.75rem; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.06); color:var(--fg); border:1px solid rgba(255,255,255,.08)}
    .pubBadge{font-size:.7rem; padding:2px 6px; border-radius:6px; background:rgba(40,199,111,.15); color:var(--good); border:1px solid rgba(40,199,111,.35)}
    .actions{display:flex; gap:8px; flex-wrap:wrap}

    .filters{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 18px}
    .empty{color:var(--muted); text-align:center; padding:40px 10px}

    /* Модал */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.6); backdrop-filter: blur(4px);
      display:none; align-items:center; justify-content:center; z-index:2000;
    }
    .modal{width:min(900px, 92vw); max-height:85vh; overflow:auto; background:#0f131c; border:1px solid rgba(255,255,255,.12); border-radius:18px; box-shadow: var(--shadow); padding:16px 16px 24px}
    .modal header{position:sticky; top:0; background:#0f131c; border:none; padding:0; margin-bottom:8px}
    .modal .titleRow{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .modal h2{margin:6px 0 0}
    .modal .content{white-space:pre-wrap; line-height:1.7}
    .closeX{font-size:20px; line-height:1; padding:6px 10px; background:transparent; border:1px solid rgba(255,255,255,.2)}
    .modal .meta{margin:6px 0 12px}

    /* Админ */
    .admin{margin-top:24px}
    .adminNote{
      background:linear-gradient(180deg, #121a2b, #0f1522);
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px; padding:12px; color:var(--muted);
    }
    .adminGrid{display:grid; grid-template-columns:1fr; gap:14px}
    .panel{
      background:linear-gradient(180deg, #14192a, #0e1422);
      border:1px solid rgba(255,255,255,.1);
      border-radius:16px; padding:14px; box-shadow: var(--shadow);
    }
    .panel h3{margin:0 0 10px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    label{font-size:.9rem; color:var(--muted)}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:12px 0}
    .mini{font-size:.85rem; color:var(--muted)}
    .danger{color:var(--bad)}
    .good{color:var(--good)}

    /* Возрастное подтверждение */
    .ageGate{
      position:fixed; inset:0; z-index:3000; display:none; align-items:center; justify-content:center;
      background: radial-gradient(120% 90% at 50% 30%, rgba(10,10,15,.95) 0%, rgba(10,10,15,.9) 100%);
    }
    .ageBox{
      width:min(560px,92vw); background:#0f131c; border:1px solid rgba(255,255,255,.12);
      border-radius:16px; padding:18px; box-shadow: var(--shadow);
      text-align:center;
    }
    .ageBox h2{margin:.2rem 0 .5rem}
    .ageBox p{color:var(--muted)}
    .ageBtns{display:flex; gap:10px; justify-content:center; margin-top:12px}
    .note{font-size:.8rem; color:var(--muted); margin-top:6px}

    footer{max-width:1100px; margin:0 auto; padding:20px 18px 40px; color:var(--muted); font-size:.9rem}

    /* Small */
    @media (max-width:600px){
      .cover-inner{flex-direction:column; text-align:center}
      .cover .symbol{width:100px; height:100px}
      .search{min-width:unset; flex:1}
    }
  </style>
</head>
<body>

  <!-- Возрастной экран -->
  <div class="ageGate" id="ageGate" role="dialog" aria-modal="true" aria-labelledby="ageTitle">
    <div class="ageBox">
      <h2 id="ageTitle">Доступ 18+</h2>
      <p>Сайт предназначен для взрослой аудитории. Подтвердите, что вам есть 18 лет.</p>
      <div class="ageBtns">
        <button class="btn-accent" id="ageYes">Мне есть 18</button>
        <button class="btn-ghost" id="ageNo">Мне нет 18</button>
      </div>
      <div class="note">Примерный контент по умолчанию не содержит откровенных материалов.</div>
    </div>
  </div>

  <!-- Верхняя панель -->
  <header>
    <div class="wrap">
      <a class="brand" href="#" aria-label="На главную">
        <div class="logo" title="Символика">
          <!-- Символ внутри логотипа (динамический) -->
          <svg id="logoSymbol" viewBox="0 0 24 24" fill="#ffffff">
            <path d="M3 21l8.7-3.3c3.9-1.5 6.7-5 7.2-9.2l.3-2.7-2.7.3c-4.2.5-7.7 3.3-9.2 7.2L4 20l-.1.3.1-.3zM13 7l4 4"/>
          </svg>
        </div>
        <div class="title">
          Рассказы по фене <span class="badge18">18+</span>
        </div>
      </a>
      <div class="spacer"></div>
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="#9db2c8" aria-hidden="true"><path d="M21 21l-4.3-4.3m2-5.2A7.5 7.5 0 1 1 5.5 4.5a7.5 7.5 0 0 1 13.2 7z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
        <input id="searchInput" type="search" placeholder="Поиск по названию, автору, тегам..." aria-label="Поиск"/>
      </div>
      <div class="toolbar">
        <button id="btnCycleCover" title="Сменить обложку">Смена обложки</button>
        <button id="btnSymbol" title="Сменить символику">Символика</button>
        <button id="btnExport" class="btn-ghost" title="Экспорт данных">Экспорт</button>
        <label class="btn-ghost" for="fileImport" title="Импорт данных" style="cursor:pointer">Импорт</label>
        <input id="fileImport" type="file" accept="application/json" style="display:none"/>
        <button id="btnAdmin" class="btn-accent" title="Войти как админ">Войти</button>
        <button id="btnLogout" class="btn-ghost" style="display:none" title="Выйти">Выйти</button>
      </div>
    </div>
  </header>

  <!-- Обложка -->
  <section id="cover" class="cover cover-1" role="banner" aria-label="Обложка">
    <div class="cover-inner">
      <div class="symbol" aria-hidden="true">
        <svg id="heroSymbol" viewBox="0 0 64 64" width="56" height="56" fill="#ffffff">
          <!-- Перо по умолчанию -->
          <path id="heroPath" d="M12 52l18-7c12-4.6 20.7-15.4 22.3-28.3l.7-6.2-6.2.7C34 12.8 23.2 21.5 18.6 33.5L12 52zM34 16l14 14"/>
        </svg>
      </div>
      <div>
        <h1>Платформа для взрослых историй</h1>
        <p>Публикуйте, редактируйте и управляйте публикациями. Яркие обложки, собственная символика и удобная админ-панель — всё в одном HTML-файле.</p>
        <div class="cover-actions">
          <button id="btnAddQuick" class="btn-accent">Добавить рассказ</button>
          <button id="btnGoAdmin" class="btn-ghost">Личный кабинет админа</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Контент -->
  <main>
    <div class="filters" aria-label="Фильтры">
      <select id="filterPublished" aria-label="Фильтр публикаций">
        <option value="all">Все</option>
        <option value="pub">Только опубликованные</option>
        <option value="draft">Только черновики</option>
      </select>
      <select id="filterTag" aria-label="Фильтр по тегу">
        <option value="">Все теги</option>
      </select>
      <span class="mini" id="countInfo"></span>
    </div>

    <div id="cards" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" style="display:none">Пока нет историй. Войдите как админ и добавьте первый рассказ.</div>

    <!-- Админ -->
    <section class="admin" id="adminSection" style="display:none">
      <div id="loginPanel" class="panel" style="display:none">
        <h3>Вход администратора</h3>
        <div class="row">
          <div>
            <label>Пароль</label>
            <input id="adminPass" type="password" placeholder="Введите пароль (по умолчанию: admin123)"/>
          </div>
        </div>
        <div class="row">
          <button id="btnLogin" class="btn-accent">Войти</button>
          <button id="btnSetPass" class="btn-ghost" title="Установить новый пароль">Сменить/задать пароль</button>
        </div>
        <div class="adminNote mini">
          Внимание: в этой демо-версии пароль хранится в вашем браузере (localStorage) и не предназначен для реальной защиты.
        </div>
      </div>

      <div id="dashPanel" class="panel" style="display:none">
        <h3>Личный кабинет админа</h3>
        <div class="mini">Управляйте рассказами, обложками и символикой. Все данные сохраняются локально в вашем браузере.</div>
        <div class="hr"></div>

        <div class="adminGrid">
          <!-- Форма создания/редактирования -->
          <div class="panel">
            <h3 id="formTitle">Новый рассказ</h3>
            <div class="row">
              <div>
                <label>Название</label>
                <input id="fTitle" type="text" placeholder="Название рассказа"/>
              </div>
              <div>
                <label>Автор</label>
                <input id="fAuthor" type="text" placeholder="Автор"/>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Теги (через запятую)</label>
                <input id="fTags" type="text" placeholder="напр., романтика, драма"/>
              </div>
              <div>
                <label>Статус</label>
                <select id="fStatus">
                  <option value="draft">Черновик</option>
                  <option value="pub">Опубликовано</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Текст рассказа</label>
                <textarea id="fContent" rows="8" placeholder="Вставьте текст (без откровенных материалов в демо)..."></textarea>
              </div>
            </div>
            <div class="row">
              <button id="btnSave" class="btn-accent">Сохранить</button>
              <button id="btnReset" class="btn-ghost">Сброс формы</button>
              <button id="btnDelete" class="btn-ghost danger" style="display:none">Удалить</button>
            </div>
            <div class="mini" id="formInfo"></div>
          </div>

          <!-- Обложки и символика -->
          <div class="panel">
            <h3>Оформление</h3>
            <div class="row">
              <div>
                <label>Тема обложки</label>
                <select id="selCover">
                  <option value="cover-1">Неон: розовый — синий</option>
                  <option value="cover-2">Теплый рассвет</option>
                  <option value="cover-3">Морская свежесть</option>
                  <option value="cover-4">Персиковый закат</option>
                  <option value="cover-5">Огненная волна</option>
                </select>
              </div>
              <div>
                <label>Символика</label>
                <select id="selSymbol">
                  <option value="quill">Перо</option>
                  <option value="mask">Маска</option>
                  <option value="bolt">Молния</option>
                </select>
              </div>
            </div>
            <div class="row">
              <button id="btnApplyBrand" class="btn-accent">Применить оформление</button>
            </div>
            <div class="mini">Символика отображается в логотипе и на обложке.</div>
          </div>

          <!-- Системные настройки -->
          <div class="panel">
            <h3>Системные действия</h3>
            <div class="row">
              <button id="btnExport2">Экспортировать все данные</button>
              <label class="btn-ghost" for="fileImport2" style="cursor:pointer">Импортировать данные</label>
              <input id="fileImport2" type="file" accept="application/json" style="display:none"/>
              <button id="btnClear" class="btn-ghost danger">Очистить все (сброс)</button>
            </div>
            <div class="adminNote mini">Экспортирует рассказы и настройки (обложка/символика/пароль). Для настоящего деплоя требуется серверная часть.</div>
          </div>

          <!-- Список историй (для админа) -->
          <div class="panel">
            <h3>Ваши рассказы</h3>
            <div id="adminList" class="grid"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Модальное окно чтения -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <header class="titleRow">
        <h2 id="modalTitle">Название рассказа</h2>
        <button class="closeX" id="modalClose" aria-label="Закрыть">✕</button>
      </header>
      <div class="meta" id="modalMeta"></div>
      <div class="content" id="modalContent"></div>
    </div>
  </div>

  <footer>
    Внимание: сайт предназначен для совершеннолетних пользователей. В этой демонстрации нет явного контента; примеры служат только для проверки интерфейса. Все данные сохраняются локально в вашем браузере.
  </footer>

  <script>
    // Хранилище
    const KEY_STORIES = 'rf_stories';
    const KEY_PASS = 'rf_password';
    const KEY_COVER = 'rf_cover';
    const KEY_SYMBOL = 'rf_symbol';
    const KEY_AGE = 'rf_age_ok';
    const KEY_SESSION = 'rf_admin_session';

    // Состояние
    let stories = [];
    let editingId = null;

    // Элементы
    const ageGate = document.getElementById('ageGate');
    const ageYes = document.getElementById('ageYes');
    const ageNo = document.getElementById('ageNo');

    const cover = document.getElementById('cover');
    const heroPath = document.getElementById('heroPath');
    const logoSymbol = document.getElementById('logoSymbol');

    const searchInput = document.getElementById('searchInput');
    const filterPublished = document.getElementById('filterPublished');
    const filterTag = document.getElementById('filterTag');
    const countInfo = document.getElementById('countInfo');

    const cards = document.getElementById('cards');
    const empty = document.getElementById('empty');

    const btnCycleCover = document.getElementById('btnCycleCover');
    const btnSymbol = document.getElementById('btnSymbol');
    const btnExport = document.getElementById('btnExport');
    const fileImport = document.getElementById('fileImport');
    const btnAdmin = document.getElementById('btnAdmin');
    const btnLogout = document.getElementById('btnLogout');

    const btnAddQuick = document.getElementById('btnAddQuick');
    const btnGoAdmin = document.getElementById('btnGoAdmin');

    const adminSection = document.getElementById('adminSection');
    const loginPanel = document.getElementById('loginPanel');
    const dashPanel = document.getElementById('dashPanel');
    const adminPass = document.getElementById('adminPass');
    const btnLogin = document.getElementById('btnLogin');
    const btnSetPass = document.getElementById('btnSetPass');

    const fTitle = document.getElementById('fTitle');
    const fAuthor = document.getElementById('fAuthor');
    const fTags = document.getElementById('fTags');
    const fStatus = document.getElementById('fStatus');
    const fContent = document.getElementById('fContent');
    const btnSave = document.getElementById('btnSave');
    const btnReset = document.getElementById('btnReset');
    const btnDelete = document.getElementById('btnDelete');
    const formTitle = document.getElementById('formTitle');
    const formInfo = document.getElementById('formInfo');

    const selCover = document.getElementById('selCover');
    const selSymbol = document.getElementById('selSymbol');
    const btnApplyBrand = document.getElementById('btnApplyBrand');

    const btnExport2 = document.getElementById('btnExport2');
    const fileImport2 = document.getElementById('fileImport2');
    const btnClear = document.getElementById('btnClear');
    const adminList = document.getElementById('adminList');

    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMeta = document.getElementById('modalMeta');
    const modalContent = document.getElementById('modalContent');
    const modalClose = document.getElementById('modalClose');

    // Утилиты
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const nowISO = () => new Date().toISOString();
    const fmtDate = iso => new Date(iso).toLocaleString();

    function load() {
      try{
        stories = JSON.parse(localStorage.getItem(KEY_STORIES) || '[]');
      } catch { stories = []; }
      if(!localStorage.getItem(KEY_PASS)) localStorage.setItem(KEY_PASS, btoa('admin123')); // base64 псевдо-хеш
      if(!localStorage.getItem(KEY_COVER)) localStorage.setItem(KEY_COVER, 'cover-1');
      if(!localStorage.getItem(KEY_SYMBOL)) localStorage.setItem(KEY_SYMBOL, 'quill');
    }
    function save() {
      localStorage.setItem(KEY_STORIES, JSON.stringify(stories));
    }

    function ensureSample() {
      if(stories.length === 0){
        stories.push({
          id: uid(),
          title: 'Первая запись (пример)',
          author: 'Админ',
          tags: ['демо','пример'],
          content: 'Это пример рассказа для проверки интерфейса. Замените этот текст собственным материалом, соблюдая законы и правила площадок.\n\nПодсказка: используйте раздел Админ → Ваши рассказы для редактирования, публикации и удаления.',
          createdAt: nowISO(),
          updatedAt: nowISO(),
          published: true
        });
        save();
      }
    }

    // Рендер символики
    function setSymbol(kind){
      const paths = {
        quill: {
          small: "M3 21l8.7-3.3c3.9-1.5 6.7-5 7.2-9.2l.3-2.7-2.7.3c-4.2.5-7.7 3.3-9.2 7.2L4 20l-.1.3.1-.3zM13 7l4 4",
          big: "M12 52l18-7c12-4.6 20.7-15.4 22.3-28.3l.7-6.2-6.2.7C34 12.8 23.2 21.5 18.6 33.5L12 52zM34 16l14 14"
        },
        mask: {
          small: "M4 5h16v6c0 5-4 8-8 8s-8-3-8-8V5zm3 5c1 1 3 2 5 2s4-1 5-2",
          big: "M8 10h48v14c0 12-10 22-24 22S8 36 8 24V10zm8 12c3 3 9 5 16 5s13-2 16-5"
        },
        bolt: {
          small: "M13 2L4 14h6l-1 8 9-12h-6l1-8z",
          big: "M34 4L14 32h12l-3 28 26-36H37l3-20z"
        }
      };
      const p = paths[kind] || paths.quill;
      logoSymbol.innerHTML = `<path d="${p.small}"/>`;
      heroPath.setAttribute('d', p.big);
      localStorage.setItem(KEY_SYMBOL, kind);
      selSymbol.value = kind;
    }

    // Рендер обложки
    function setCover(cls){
      cover.className = 'cover ' + cls;
      localStorage.setItem(KEY_COVER, cls);
      selCover.value = cls;
    }
    function cycleCover(){
      const all = ['cover-1','cover-2','cover-3','cover-4','cover-5'];
      const cur = localStorage.getItem(KEY_COVER) || 'cover-1';
      const idx = (all.indexOf(cur) + 1) % all.length;
      setCover(all[idx]);
    }

    // Фильтры/поиск
    function getFiltered(){
      const q = (searchInput.value || '').toLowerCase().trim();
      const tag = (filterTag.value || '').toLowerCase().trim();
      const fp = filterPublished.value;
      let list = stories.slice().sort((a,b)=> new Date(b.updatedAt) - new Date(a.updatedAt));
      if(fp === 'pub') list = list.filter(s=> s.published);
      if(fp === 'draft') list = list.filter(s=> !s.published);
      if(tag) list = list.filter(s => (s.tags||[]).some(t => t.toLowerCase() === tag));
      if(q){
        list = list.filter(s => 
          (s.title||'').toLowerCase().includes(q) ||
          (s.author||'').toLowerCase().includes(q) ||
          (s.tags||[]).some(t => t.toLowerCase().includes(q)) ||
          (s.content||'').toLowerCase().includes(q)
        );
      }
      return list;
    }

    // Рендер списка
    function renderList(){
      const data = getFiltered();
      cards.innerHTML = '';
      if(data.length === 0){
        empty.style.display = 'block';
        countInfo.textContent = '';
      } else {
        empty.style.display = 'none';
        countInfo.textContent = `Найдено: ${data.length}`;
      }
      data.forEach(s => {
        const el = document.createElement('div');
        el.className = 'card';
        const tagsHtml = (s.tags||[]).map(t=> `<span class="tag">${escapeHtml(t)}</span>`).join('');
        el.innerHTML = `
          <h3>${escapeHtml(s.title)}</h3>
          <div class="meta">Автор: ${escapeHtml(s.author || '—')}</div>
          <div class="tags">${tagsHtml}</div>
          <div class="actions">
            <button data-act="read" class="btn-accent">Читать</button>
            <span class="spacer"></span>
            ${s.published ? '<span class="pubBadge">Опубликовано</span>' : '<span class="mini">Черновик</span>'}
          </div>
        `;
        el.querySelector('[data-act="read"]').addEventListener('click', ()=> openModal(s.id));
        cards.appendChild(el);
      });

      // Заполнить селект тегов
      const allTags = Array.from(new Set(stories.flatMap(s => s.tags||[]))).sort((a,b)=> a.localeCompare(b,'ru'));
      filterTag.innerHTML = '<option value="">Все теги</option>' + allTags.map(t=> `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
      if(allTags.includes(filterTag.value) === false) filterTag.value = '';
    }

    // Модал
    function openModal(id){
      const s = stories.find(x => x.id === id);
      if(!s) return;
      modalTitle.textContent = s.title || 'Без названия';
      modalMeta.textContent = `Автор: ${s.author || '—'} • Обновлено: ${fmtDate(s.updatedAt)}`;
      modalContent.textContent = s.content || '';
      modal.style.display = 'flex';
    }
    function closeModal(){ modal.style.display = 'none'; }
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', e => { if(e.target === modal) closeModal(); });

    // Админ
    function isLogged(){ return localStorage.getItem(KEY_SESSION) === '1'; }
    function showAdmin(){
      adminSection.style.display = 'block';
      const logged = isLogged();
      loginPanel.style.display = logged ? 'none' : 'block';
      dashPanel.style.display = logged ? 'block' : 'none';
      btnAdmin.style.display = logged ? 'none' : 'inline-block';
      btnLogout.style.display = logged ? 'inline-block' : 'none';
      if(logged) renderAdminList();
    }
    function hideAdmin(){
      adminSection.style.display = 'none';
    }
    function login(){
      const passStored = localStorage.getItem(KEY_PASS) || '';
      const val = adminPass.value || '';
      if(btoa(val) === passStored){
        localStorage.setItem(KEY_SESSION, '1');
        adminPass.value = '';
        showAdmin();
      } else {
        alert('Неверный пароль');
      }
    }
    function logout(){
      localStorage.removeItem(KEY_SESSION);
      showAdmin();
    }
    function setPassword(){
      const p1 = prompt('Введите новый пароль (минимум 6 символов):');
      if(!p1) return;
      if(p1.length < 6) return alert('Слишком короткий пароль.');
      const p2 = prompt('Повторите пароль:');
      if(p1 !== p2) return alert('Пароли не совпадают.');
      localStorage.setItem(KEY_PASS, btoa(p1));
      alert('Пароль обновлён.');
    }

    // CRUD
    function resetForm(){
      editingId = null;
      fTitle.value = '';
      fAuthor.value = '';
      fTags.value = '';
      fStatus.value = 'draft';
      fContent.value = '';
      formTitle.textContent = 'Новый рассказ';
      btnDelete.style.display = 'none';
      formInfo.textContent = '';
    }
    function saveForm(){
      const title = fTitle.value.trim();
      const author = fAuthor.value.trim();
      const tags = fTags.value.split(',').map(t=> t.trim()).filter(Boolean);
      const published = fStatus.value === 'pub';
      const content = fContent.value;
      if(!title) return alert('Введите название.');
      const payload = {
        title, author, tags, content, published
      };
      if(editingId){
        const idx = stories.findIndex(s => s.id === editingId);
        if(idx >= 0){
          stories[idx] = { ...stories[idx], ...payload, updatedAt: nowISO() };
        }
        formInfo.innerHTML = '<span class="good">Изменения сохранены.</span>';
      } else {
        stories.push({
          id: uid(),
          ...payload,
          createdAt: nowISO(),
          updatedAt: nowISO()
        });
        formInfo.innerHTML = '<span class="good">Рассказ добавлен.</span>';
      }
      save();
      renderList();
      renderAdminList();
      if(!editingId) resetForm();
    }
    function editStory(id){
      const s = stories.find(x => x.id === id);
      if(!s) return;
      editingId = id;
      fTitle.value = s.title || '';
      fAuthor.value = s.author || '';
      fTags.value = (s.tags||[]).join(', ');
      fStatus.value = s.published ? 'pub' : 'draft';
      fContent.value = s.content || '';
      formTitle.textContent = 'Редактирование рассказа';
      btnDelete.style.display = 'inline-block';
      formInfo.textContent = '';
      window.scrollTo({top: adminSection.offsetTop, behavior:'smooth'});
    }
    function removeStory(id){
      if(!confirm('Удалить рассказ? Это действие нельзя отменить.')) return;
      stories = stories.filter(s => s.id !== id);
      save();
      renderList();
      renderAdminList();
      if(editingId === id) resetForm();
    }
    function togglePublish(id){
      const s = stories.find(x => x.id === id);
      if(!s) return;
      s.published = !s.published;
      s.updatedAt = nowISO();
      save();
      renderList();
      renderAdminList();
    }

    function renderAdminList(){
      adminList.innerHTML = '';
      if(stories.length === 0){
        adminList.innerHTML = '<div class="empty">Нет записей</div>';
        return;
      }
      stories.slice().sort((a,b)=> new Date(b.updatedAt) - new Date(a.updatedAt)).forEach(s => {
        const item = document.createElement('div');
        item.className = 'card';
        item.innerHTML = `
          <h3>${escapeHtml(s.title)}</h3>
          <div class="meta">Автор: ${escapeHtml(s.author||'—')} • Изм.: ${fmtDate(s.updatedAt)}</div>
          <div class="tags">${(s.tags||[]).map(t=> `<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
          <div class="actions">
            <button data-act="edit">Редактировать</button>
            <button data-act="read" class="btn-ghost">Читать</button>
            <button data-act="pub" class="${s.published ? 'btn-ghost' : 'btn-accent'}">${s.published ? 'Снять с публ.' : 'Опубликовать'}</button>
            <button data-act="del" class="btn-ghost danger">Удалить</button>
          </div>
        `;
        item.querySelector('[data-act="edit"]').addEventListener('click', ()=> editStory(s.id));
        item.querySelector('[data-act="read"]').addEventListener('click', ()=> openModal(s.id));
        item.querySelector('[data-act="pub"]').addEventListener('click', ()=> togglePublish(s.id));
        item.querySelector('[data-act="del"]').addEventListener('click', ()=> removeStory(s.id));
        adminList.appendChild(item);
      });
    }

    // Экспорт/импорт
    function exportAll(){
      const data = {
        stories,
        cover: localStorage.getItem(KEY_COVER),
        symbol: localStorage.getItem(KEY_SYMBOL),
        password: localStorage.getItem(KEY_PASS)
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'rf_export.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function importAll(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(Array.isArray(data.stories)) stories = data.stories;
          if(data.cover) localStorage.setItem(KEY_COVER, data.cover);
          if(data.symbol) localStorage.setItem(KEY_SYMBOL, data.symbol);
          if(data.password) localStorage.setItem(KEY_PASS, data.password);
          save();
          applyBrand();
          renderList();
          if(isLogged()) renderAdminList();
          alert('Импорт завершён.');
        }catch(e){
          alert('Ошибка импорта: ' + e.message);
        }
      };
      reader.readAsText(file);
    }

    // Безопасность вывода
    function escapeHtml(s){
      return (s ?? '').toString()
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    // Оформление
    function applyBrand(){
      setCover(localStorage.getItem(KEY_COVER) || 'cover-1');
      setSymbol(localStorage.getItem(KEY_SYMBOL) || 'quill');
    }

    // Возраст
    function initAge(){
      const ok = localStorage.getItem(KEY_AGE) === '1';
      if(!ok){
        ageGate.style.display = 'flex';
      }
      ageYes.addEventListener('click', ()=>{
        localStorage.setItem(KEY_AGE, '1');
        ageGate.style.display = 'none';
      });
      ageNo.addEventListener('click', ()=>{
        alert('Доступ закрыт. Возвращайтесь позже.');
        // Можно скрыть основной контент:
        ageGate.style.display = 'flex';
      });
    }

    // Слушатели
    function bind(){
      searchInput.addEventListener('input', renderList);
      filterPublished.addEventListener('change', renderList);
      filterTag.addEventListener('change', renderList);

      btnCycleCover.addEventListener('click', cycleCover);
      btnSymbol.addEventListener('click', ()=>{
        const opts = ['quill','mask','bolt'];
        const cur = localStorage.getItem(KEY_SYMBOL) || 'quill';
        const next = opts[(opts.indexOf(cur)+1)%opts.length];
        setSymbol(next);
      });
      btnExport.addEventListener('click', exportAll);
      fileImport.addEventListener('change', (e)=> e.target.files[0] && importAll(e.target.files[0]));

      btnAdmin.addEventListener('click', ()=> { showAdmin(); loginPanel.scrollIntoView({behavior:'smooth'}); });
      btnLogout.addEventListener('click', logout);

      btnAddQuick.addEventListener('click', ()=> { showAdmin(); dashPanel.scrollIntoView({behavior:'smooth'}); });
      btnGoAdmin.addEventListener('click', ()=> { showAdmin(); dashPanel.scrollIntoView({behavior:'smooth'}); });

      btnLogin.addEventListener('click', login);
      btnSetPass.addEventListener('click', setPassword);

      btnSave.addEventListener('click', saveForm);
      btnReset.addEventListener('click', resetForm);
      btnDelete.addEventListener('click', ()=> { if(editingId) removeStory(editingId); });

      selCover.addEventListener('change', ()=> setCover(selCover.value));
      selSymbol.addEventListener('change', ()=> setSymbol(selSymbol.value));
      btnApplyBrand.addEventListener('click', applyBrand);

      btnExport2.addEventListener('click', exportAll);
      fileImport2.addEventListener('change', (e)=> e.target.files[0] && importAll(e.target.files[0]));
      btnClear.addEventListener('click', ()=>{
        if(!confirm('Очистить все данные и настройки?')) return;
        localStorage.removeItem(KEY_STORIES);
        localStorage.removeItem(KEY_COVER);
        localStorage.removeItem(KEY_SYMBOL);
        localStorage.removeItem(KEY_PASS);
        localStorage.removeItem(KEY_SESSION);
        stories = [];
        load();
        ensureSample();
        applyBrand();
        renderList();
        showAdmin();
        resetForm();
        alert('Сброшено.');
      });
    }

    // Инициализация
    function init(){
      load();
      ensureSample();
      applyBrand();
      initAge();
      bind();
      renderList();
      if(isLogged()) showAdmin();
      else hideAdmin();
      resetForm();
    }

    // Старт
    init();
  </script>
</body>
</html>